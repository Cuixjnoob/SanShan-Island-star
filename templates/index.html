<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å±±å²›è§‚æ˜Ÿé€‰å€ç³»ç»Ÿ - æ¢ç´¢æ˜Ÿç©ºä¹‹ç¾</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/star-bg.css') }}">
    <style>
        :root {
            /* LeetCode Dark Theme Inspired Colors */
            --lc-bg: #1a1a1a;
            --lc-card-bg: #282828;
            --lc-card-hover: #323232;
            --lc-text-main: #eff1f6;
            --lc-text-sub: #8a8a8a;
            --lc-primary: #ffa116; /* LeetCode Orange */
            --lc-accent: #0a84ff; /* LeetCode Blue */
            --lc-success: #2cbb5d;
            --lc-warning: #ffc01e;
            --lc-danger: #ef4743;
            --lc-border: #3e3e3e;
            --lc-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            --lc-radius: 8px;
            --lc-font: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--lc-font);
            background-color: var(--lc-bg);
            min-height: 100vh;
            color: var(--lc-text-main);
            line-height: 1.6;
            position: relative;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* LeetCodeé£æ ¼å¡ç‰‡é€šç”¨æ ·å¼ */
        .hydro-card {
            background: var(--lc-card-bg);
            border-radius: var(--lc-radius);
            box-shadow: var(--lc-shadow);
            margin-bottom: 20px;
            padding: 24px;
            border: 1px solid transparent; /* LeetCode cards usually don't have borders in dark mode, or very subtle */
        }

        header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            color: var(--lc-text-main);
            font-weight: 600;
        }

        .subtitle {
            font-size: 1em;
            color: var(--lc-text-sub);
            font-weight: 400;
        }

        /* ç³»ç»Ÿä¿¡æ¯å¡ç‰‡ç»„ */
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-card {
            background: var(--lc-card-bg);
            padding: 20px;
            border-radius: var(--lc-radius);
            box-shadow: var(--lc-shadow);
            text-align: center;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background: var(--lc-card-hover);
        }

        .info-card h3 {
            font-size: 0.85em;
            color: var(--lc-text-sub);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .info-card .value {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--lc-text-main); /* LeetCode uses white for numbers usually */
        }

        /* å¤©æ°”å¡ç‰‡æ ·å¼ */
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 24px;
        }

        .weather-card {
            background: var(--lc-card-bg);
            padding: 15px;
            border-radius: var(--lc-radius);
            border: 1px solid var(--lc-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .weather-card i {
            font-size: 1.5em;
            margin-bottom: 8px;
            color: var(--lc-primary);
        }

        .weather-card .label {
            font-size: 0.85em;
            color: var(--lc-text-sub);
            margin-bottom: 4px;
        }

        .weather-card .data {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--lc-text-main);
        }

        .condition-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 5px;
        }

        /* è§‚æµ‹ç‚¹åˆ—è¡¨ */
        .points-list {
            background: var(--lc-card-bg);
            border-radius: var(--lc-radius);
            box-shadow: var(--lc-shadow);
            margin-bottom: 24px;
            padding: 24px;
        }

        .points-list h2 {
            font-size: 1.4em;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--lc-border);
            color: var(--lc-text-main);
            font-weight: 600;
        }

        .points-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        /* åœ°å›¾å®¹å™¨æ ·å¼ */
        #map-container {
            height: 400px;
            width: 100%;
            border-radius: var(--lc-radius);
            margin-bottom: 20px;
            z-index: 1;
            border: 1px solid var(--lc-border);
        }

        .point-item {
            background: var(--lc-card-bg);
            padding: 20px;
            border-radius: var(--lc-radius);
            border: 1px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: var(--lc-shadow);
        }

        .point-item:hover {
            background: var(--lc-card-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .point-item h3 {
            color: var(--lc-text-main);
            font-size: 1.1em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .point-item p {
            font-size: 0.9em;
            color: var(--lc-text-sub);
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .point-item p i {
            width: 16px;
            text-align: center;
            color: var(--lc-text-sub);
        }

        /* æœç´¢åŒºåŸŸ */
        .search-section {
            background: var(--lc-card-bg);
            border-radius: var(--lc-radius);
            box-shadow: var(--lc-shadow);
            margin-bottom: 24px;
            padding: 24px;
        }

        .time-selector {
            background: var(--lc-bg);
            padding: 16px;
            border-radius: var(--lc-radius);
            margin-bottom: 20px;
            border: 1px solid var(--lc-border);
        }

        .time-selector h3 {
            font-size: 1em;
            color: var(--lc-text-main);
            margin-bottom: 15px;
            border-bottom: 1px solid var(--lc-border);
            padding-bottom: 10px;
            font-weight: 600;
        }

        .time-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .time-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--lc-text-sub);
        }

        /* è¾“å…¥æ¡†å’ŒæŒ‰é’® */
        input[type="text"], 
        input[type="datetime-local"],
        select {
            background: var(--lc-bg);
            border: 1px solid var(--lc-border);
            color: var(--lc-text-main);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.95em;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, 
        input[type="datetime-local"]:focus,
        select:focus {
            border-color: var(--lc-primary);
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
        }
        
        .search-box select {
            padding: 10px 15px;
            cursor: pointer;
        }

        .btn {
            background: var(--lc-bg);
            color: var(--lc-text-main);
            border: 1px solid var(--lc-border);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: none;
        }

        .btn:hover {
            background: var(--lc-card-hover);
            border-color: var(--lc-text-sub);
        }
        
        /* Primary Button Style */
        .btn-primary, #updateTimeBtn, #refreshBtn {
            background: var(--lc-primary);
            color: #fff; /* Orange bg needs white text */
            border: none;
        }
        
        .btn-primary:hover, #updateTimeBtn:hover, #refreshBtn:hover {
            background: #e59113; /* Darker orange */
            border: none;
        }

        #resetTimeBtn {
            background: var(--lc-bg);
            border: 1px solid var(--lc-border);
        }
        #resetTimeBtn:hover {
            background: var(--lc-card-hover);
        }

        /* æ˜Ÿæ˜Ÿåˆ—è¡¨ */
        .visible-stars-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        .star-card {
            background: var(--lc-bg);
            border: 1px solid var(--lc-border);
            border-radius: var(--lc-radius);
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .star-card:hover {
            border-color: var(--lc-primary);
            background: var(--lc-card-hover);
        }

        .star-card.planet {
            border-left: 3px solid var(--lc-warning);
        }

        .star-name {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--lc-text-main);
            margin-bottom: 4px;
        }

        .star-name-en {
            font-size: 0.85em;
            color: var(--lc-text-sub);
            margin-bottom: 10px;
        }

        .star-details {
            font-size: 0.85em;
            color: var(--lc-text-sub);
            line-height: 1.6;
        }

        .star-altitude {
            display: inline-block;
            margin-top: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            background: var(--lc-bg);
        }

        /* è¦†ç›–ä¹‹å‰çš„æ¸å˜èƒŒæ™¯ï¼Œä½¿ç”¨çº¯è‰²æ ‡ç­¾ */
        .star-altitude[style*="10b981"] { /* æœ€ä½³è§‚æµ‹ */
            background: rgba(44, 187, 93, 0.15) !important;
            color: var(--lc-success);
            border: none;
        }
        .star-altitude[style*="3b82f6"] { /* å¯è§ */
            background: rgba(10, 132, 255, 0.15) !important;
            color: var(--lc-accent);
            border: none;
        }
        .star-altitude[style*="f59e0b"] { /* åœ°å¹³çº¿é™„è¿‘ */
            background: rgba(255, 192, 30, 0.15) !important;
            color: var(--lc-warning);
            border: none;
        }

        /* åŠ è½½å’Œé”™è¯¯çŠ¶æ€ */
        .loading, .error {
            text-align: center;
            padding: 40px;
            color: var(--lc-text-sub);
            background: var(--lc-card-bg);
            border-radius: var(--lc-radius);
        }

        .compass {
            font-size: 2em;
            margin-bottom: 10px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            h1 { font-size: 1.8em; }
            .search-box { flex-direction: column; }
            .time-controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âœ¨ ä¸‰å±±å²›è§‚æ˜Ÿé€‰å€ç³»ç»Ÿ</h1>
        </header>

        <div class="system-info">
            <div class="info-card">
                <h3><i class="fas fa-map-marker-alt"></i> è§‚æµ‹ç‚¹æ•°é‡</h3>
                <div class="value" id="pointCount">-</div>
            </div>
            <div class="info-card">
                <h3><i class="fas fa-star"></i> å¯è§å¤©ä½“</h3>
                <div class="value" id="visibleCount">-</div>
            </div>
            <div class="info-card">
                <h3><i class="fas fa-clock"></i> å½“å‰æ—¶é—´</h3>
                <div class="value" id="currentTime" style="font-size: 1.8em;">-</div>
            </div>
            <div class="info-card">
                <h3><i class="fas fa-signal"></i> ç³»ç»ŸçŠ¶æ€</h3>
                <div class="value" id="systemStatus" style="font-size: 1.5em;">è¿è¡Œä¸­</div>
            </div>
        </div>

        <div class="search-section">
            <div class="time-selector">
                <h3><i class="fas fa-clock"></i> è§‚æµ‹æ—¶é—´è®¾ç½®</h3>
                <div class="time-controls">
                    <input type="datetime-local" id="observationTime" />
                    <button id="resetTimeBtn" class="btn" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4);">
                        <span><i class="fas fa-clock"></i> å½“å‰æ—¶é—´</span>
                    </button>
                    <button id="updateTimeBtn" class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);">
                        <span><i class="fas fa-sync-alt"></i> æ›´æ–°æ˜Ÿä½“</span>
                    </button>
                </div>
                <div class="time-info">
                    æŸ¥è¯¢æ—¶é—´: <span id="queryTimeDisplay">-</span>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢æ˜Ÿæ˜Ÿåç§°ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰..." autocomplete="off">
                
                <select id="typeFilter">
                    <option value="all">ğŸª æ‰€æœ‰ç±»å‹</option>
                    <option value="star">âœ¨ æ’æ˜Ÿ</option>
                    <option value="planet">ğŸŒ è¡Œæ˜Ÿ</option>
                </select>
                
                <select id="toolFilter">
                    <option value="all">ğŸ”­ æ‰€æœ‰å·¥å…·</option>
                    <option value="naked">ğŸ‘€ è‚‰çœ¼å¯è§</option>
                </select>

                <button id="showAllBtn" class="btn"><span><i class="fas fa-th"></i> æ˜¾ç¤ºå…¨éƒ¨</span></button>
                <button id="refreshBtn" class="btn"><span><i class="fas fa-sync-alt"></i> åˆ·æ–°å¯è§</span></button>
            </div>
            
            <div id="visibleStars" class="visible-stars-grid"></div>
        </div>

        <div id="results" class="results-section"></div>

        <div class="hydro-card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h2><i class="fas fa-cloud-sun"></i> å®æ—¶å¤©æ°”ä¸è§‚æ˜Ÿæ¡ä»¶</h2>
            </div>
            <div id="weather-container" class="weather-grid">
                <div class="loading" style="grid-column: 1/-1; padding: 20px;">
                    <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è·å–å¤©æ°”æ•°æ®...
                </div>
            </div>
        </div>

        <div class="hydro-card">
            <div class="card-header">
                <h2><i class="fas fa-map-marked-alt"></i> è§‚æµ‹ç‚¹åœ°å›¾</h2>
            </div>
            <div id="map-container"></div>
        </div>

        <div class="points-list">
            <h2><i class="fas fa-location-dot"></i> è§‚æµ‹ç‚¹åˆ—è¡¨</h2>
            <div id="pointsList" class="points-grid"></div>
        </div>

        <footer style="text-align: center; margin-top: 40px; padding: 20px; color: var(--lc-text-sub); border-top: 1px solid var(--lc-border);">
            <p style="margin-bottom: 10px; font-size: 0.9em;">Presented by</p>
            <p><i class="fas fa-users"></i> å´”è¡Œéª¥ æ½˜å½¦å® ç‹æ™Ÿç‘„ ä¸¥ä»¥æ­£ èµµæ³Šé’§ èµµå‘¨éºŸ</p>
        </footer>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const showAllBtn = document.getElementById('showAllBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const updateTimeBtn = document.getElementById('updateTimeBtn');
        const resetTimeBtn = document.getElementById('resetTimeBtn');
        const observationTimeInput = document.getElementById('observationTime');
        const queryTimeDisplay = document.getElementById('queryTimeDisplay');
        const resultsDiv = document.getElementById('results');
        const visibleStarsDiv = document.getElementById('visibleStars');
        const typeFilter = document.getElementById('typeFilter');
        const toolFilter = document.getElementById('toolFilter');
        
        let allStarsData = []; // å­˜å‚¨æ‰€æœ‰æ˜Ÿæ˜Ÿæ•°æ®
        let currentStarsData = []; // å½“å‰æ˜¾ç¤ºçš„æ˜Ÿæ˜Ÿæ•°æ®ï¼ˆå¯è§æˆ–å…¨éƒ¨ï¼‰
        let currentMode = 'visible'; // 'visible' æˆ– 'all'

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initializeObservationTime();
            loadSystemInfo();
            loadVisibleStars();
            loadAllStars(); // é¢„åŠ è½½æ‰€æœ‰æ˜Ÿæ˜Ÿæ•°æ®
            initMap(); // åˆå§‹åŒ–åœ°å›¾
            updateTime();
            setInterval(updateTime, 1000); // æ¯ç§’æ›´æ–°æ—¶é—´
        });

        // ç»Ÿä¸€è¿‡æ»¤å‡½æ•°
        function applyFilters() {
            const query = searchInput.value.trim().toLowerCase();
            const type = typeFilter.value;
            const tool = toolFilter.value;

            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œç›´æ¥è¿”å›
            if (!currentStarsData || currentStarsData.length === 0) return;

            const filtered = currentStarsData.filter(star => {
                // 1. æ–‡æœ¬æœç´¢
                const matchText = star.name.toLowerCase().includes(query) || star.name_cn.includes(query);
                if (!matchText) return false;

                // 2. ç±»å‹è¿‡æ»¤
                if (type !== 'all' && star.type !== type) return false;

                // 3. å·¥å…·è¿‡æ»¤
                if (tool !== 'all') {
                    // è¡Œæ˜Ÿé€šå¸¸å¾ˆäº®ï¼Œè§†ä¸ºè‚‰çœ¼å¯è§ï¼ˆé™¤éç‰¹åˆ«æš—ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
                    // å¦‚æœ magnitude ä¸º null (è¡Œæ˜Ÿ)ï¼Œè®¾ä¸º -100 (æäº®)
                    const mag = star.magnitude !== null ? star.magnitude : -100; 
                    
                    if (tool === 'naked') {
                        // è‚‰çœ¼å¯è§: æ¨¡æ‹ŸåŸå¸‚ç¯å¢ƒï¼Œåªæ˜¾ç¤ºè¾ƒäº®çš„æ˜Ÿæ˜Ÿ (< 2.0)
                        if (mag >= 2.0) return false;
                    }
                }

                return true;
            });

            if (currentMode === 'visible') {
                displayVisibleStars(filtered);
            } else {
                displayAllStarsList(filtered);
            }
        }

        // ç›‘å¬è¿‡æ»¤å™¨å˜åŒ–
        typeFilter.addEventListener('change', applyFilters);
        toolFilter.addEventListener('change', applyFilters);
        searchInput.addEventListener('input', applyFilters);

        // åˆå§‹åŒ–è§‚æµ‹æ—¶é—´ä¸ºå½“å‰æ—¶é—´
        function initializeObservationTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            observationTimeInput.value = localDateTime;
            updateQueryTimeDisplay();
        }

        // æ›´æ–°æŸ¥è¯¢æ—¶é—´æ˜¾ç¤º
        function updateQueryTimeDisplay() {
            if (observationTimeInput.value) {
                const dt = new Date(observationTimeInput.value);
                queryTimeDisplay.textContent = dt.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }
        }

        // ç›‘å¬æ—¶é—´é€‰æ‹©å˜åŒ– - åªæ›´æ–°æ˜¾ç¤ºï¼Œä¸è‡ªåŠ¨åˆ·æ–°
        observationTimeInput.addEventListener('change', () => {
            updateQueryTimeDisplay();
        });

        // é‡ç½®ä¸ºå½“å‰æ—¶é—´æŒ‰é’®
        resetTimeBtn.addEventListener('click', () => {
            initializeObservationTime();
        });

        // æ›´æ–°æ˜Ÿä½“æŒ‰é’® - ä½¿ç”¨é€‰å®šçš„æ—¶é—´åˆ·æ–°å¯è§æ˜Ÿä½“
        updateTimeBtn.addEventListener('click', () => {
            if (currentMode === 'visible') {
                loadVisibleStars();
            }
        });

        // åˆ·æ–°æŒ‰é’® - åˆ·æ–°å¯è§æ˜Ÿæ˜Ÿ
        refreshBtn.addEventListener('click', () => {
            currentMode = 'visible';
            searchInput.value = '';
            typeFilter.value = 'all';
            toolFilter.value = 'all';
            resultsDiv.style.display = 'none';
            loadSystemInfo();
            loadVisibleStars();
        });
        
        // æ˜¾ç¤ºå…¨éƒ¨æŒ‰é’®
        showAllBtn.addEventListener('click', () => {
            currentMode = 'all';
            searchInput.value = '';
            typeFilter.value = 'all';
            toolFilter.value = 'all';
            resultsDiv.style.display = 'none';
            displayAllStars();
        });
        
        // æœç´¢åŠŸèƒ½ (å·²æ•´åˆåˆ° applyFilters)
        // searchInput.addEventListener('input', ...);

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
            document.getElementById('currentTime').textContent = timeStr;
        }

        // åŠ è½½ç³»ç»Ÿä¿¡æ¯
        async function loadSystemInfo() {
            try {
                const response = await fetch('/api/points');
                const data = await response.json();
                
                if (response.ok && Array.isArray(data)) {
                    document.getElementById('pointCount').textContent = data.length;
                    document.getElementById('systemStatus').textContent = 'âœ“ æ­£å¸¸';
                    document.getElementById('systemStatus').style.color = '#00ff00';
                    
                    // æ˜¾ç¤ºè§‚æµ‹ç‚¹åˆ—è¡¨
                    displayPointsList(data);
                }
            } catch (error) {
                document.getElementById('systemStatus').textContent = 'âœ— å¼‚å¸¸';
                document.getElementById('systemStatus').style.color = '#ff0000';
            }
        }

        // æ˜¾ç¤ºè§‚æµ‹ç‚¹åˆ—è¡¨
        function displayPointsList(points) {
            const pointsListDiv = document.getElementById('pointsList');
            
            if (points.length === 0) {
                pointsListDiv.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #94a3b8;">æ— è§‚æµ‹ç‚¹æ•°æ®</p>';
                return;
            }

            let html = '';
            points.forEach(point => {
                html += `
                    <div class="point-item" onclick="window.location.href='/point/${encodeURIComponent(point.name)}'">
                        <h3><i class="fas fa-map-pin"></i> ${point.name}</h3>
                        <p><i class="fas fa-compass"></i> ç»åº¦: ${point.longitude.toFixed(3)}Â°</p>
                        <p><i class="fas fa-compass"></i> çº¬åº¦: ${point.latitude.toFixed(3)}Â°</p>
                        <p><i class="fas fa-hiking"></i> éš¾åº¦: ${point.difficulty}</p>
                        <p><i class="fas fa-eye"></i> è§†è§’: ${point.view_start}Â° - ${point.view_end}Â°</p>
                    </div>
                `;
            });
            
            pointsListDiv.innerHTML = html;
        }

        // åŠ è½½æ‰€æœ‰æ˜Ÿæ˜Ÿæ•°æ®ï¼ˆç”¨äºæœç´¢ï¼‰
        async function loadAllStars() {
            try {
                const response = await fetch('/api/all-stars');
                const data = await response.json();
                if (response.ok) {
                    allStarsData = data.celestial_objects;
                }
            } catch (error) {
                console.error('åŠ è½½æ‰€æœ‰æ˜Ÿæ˜Ÿæ•°æ®å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ˜Ÿæ˜Ÿï¼ˆä¸ç®¡æ˜¯å¦å¯è§ï¼‰
        async function displayAllStars() {
            visibleStarsDiv.innerHTML = '<div class="loading" style="grid-column: 1/-1;"><div class="compass">âœ¨</div><p>æ­£åœ¨åŠ è½½æ‰€æœ‰å¤©ä½“æ•°æ®...</p></div>';
            
            if (allStarsData.length === 0) {
                await loadAllStars();
            }
            
            currentStarsData = allStarsData;
            applyFilters();
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(filtered, query) {
            if (filtered.length === 0) {
                visibleStarsDiv.innerHTML = `<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8; font-size: 1.1em;"><i class="fas fa-search"></i> æœªæ‰¾åˆ°åŒ…å« "${query}" çš„å¤©ä½“</p>`;
                return;
            }
            
            let html = `<h3 style="grid-column: 1/-1; color: #60a5fa; margin-bottom: 10px; font-size: 1.3em;"><i class="fas fa-search"></i> æœç´¢ç»“æœï¼ˆå…±${filtered.length}ä¸ªï¼‰</h3>`;
            filtered.forEach(star => {
                const cardClass = star.type === 'planet' ? 'star-card planet' : 'star-card';
                const typeIcon = star.type === 'planet' ? '<i class="fas fa-globe"></i>' : '<i class="fas fa-star"></i>';
                const magText = star.magnitude !== null ? `äº®åº¦: ${star.magnitude.toFixed(2)}` : 'è¡Œæ˜Ÿ';
                
                html += `
                    <div class="${cardClass}" onclick="selectStar('${star.name}')">
                        <div class="star-name">${typeIcon} ${star.name_cn}</div>
                        <div class="star-name-en">${star.name}</div>
                        <div class="star-details">${magText}</div>
                    </div>
                `;
            });
            
            visibleStarsDiv.innerHTML = html;
        }

        async function loadVisibleStars() {
            visibleStarsDiv.innerHTML = '<div class="loading" style="grid-column: 1/-1;"><div class="compass">âœ¨</div><p>æ­£åœ¨åŠ è½½å®æ—¶æ˜Ÿç©ºæ•°æ®...</p></div>';
            currentMode = 'visible';
            showAllBtn.textContent = 'æ˜¾ç¤ºå…¨éƒ¨';

            try {
                console.log('å¼€å§‹åŠ è½½å¯è§æ˜Ÿæ˜Ÿ...');
                
                // è·å–é€‰å®šçš„è§‚æµ‹æ—¶é—´
                let url = '/api/visible-stars?min_altitude=0';
                if (observationTimeInput.value) {
                    const obsTime = new Date(observationTimeInput.value).toISOString();
                    url += `&obs_time=${encodeURIComponent(obsTime)}`;
                    console.log('ä½¿ç”¨è§‚æµ‹æ—¶é—´:', obsTime);
                }
                
                const response = await fetch(url);
                console.log('å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('å“åº”æ•°æ®:', data);

                if (!response.ok) {
                    throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                }

                currentStarsData = data.stars; // ä¿å­˜å½“å‰æ•°æ®
                applyFilters(); // åº”ç”¨è¿‡æ»¤å™¨æ˜¾ç¤º
                
                // æ›´æ–°å¯è§å¤©ä½“æ•°é‡
                document.getElementById('visibleCount').textContent = data.count || data.stars.length;
            } catch (error) {
                console.error('åŠ è½½é”™è¯¯:', error);
                visibleStarsDiv.innerHTML = `<div class="error" style="grid-column: 1/-1;"><i class="fas fa-exclamation-triangle"></i> åŠ è½½å¤±è´¥: ${error.message}</div>`;
                document.getElementById('visibleCount').textContent = '0';
            }
        }

        function displayVisibleStars(stars) {
            if (stars.length === 0) {
                visibleStarsDiv.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8; font-size: 1.1em;"><i class="fas fa-moon"></i> å½“å‰æ— å¯è§å¤©ä½“</p>';
                return;
            }

            let html = '<h3 style="grid-column: 1/-1; color: #60a5fa; margin-bottom: 15px; font-size: 1.3em;"><i class="fas fa-eye"></i> å½“å‰å¯è§å¤©ä½“ï¼ˆå…±' + stars.length + 'ä¸ªï¼‰</h3>';
            stars.forEach(star => {
                const cardClass = star.type === 'planet' ? 'star-card planet' : 'star-card';
                const typeIcon = star.type === 'planet' ? '<i class="fas fa-globe"></i>' : '<i class="fas fa-star"></i>';
                
                // æ ¹æ®é«˜åº¦è§’åˆ¤æ–­å¯è§æ€§ç­‰çº§
                let visibilityBadge = '';
                if (star.altitude >= 30) {
                    visibilityBadge = '<span class="star-altitude" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%;"><i class="fas fa-circle-check"></i> æœ€ä½³è§‚æµ‹</span>';
                } else if (star.altitude >= 15) {
                    visibilityBadge = '<span class="star-altitude" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%;"><i class="fas fa-eye"></i> å¯è§</span>';
                } else {
                    visibilityBadge = '<span class="star-altitude" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%;"><i class="fas fa-triangle-exclamation"></i> åœ°å¹³çº¿é™„è¿‘</span>';
                }
                
                html += `
                    <div class="${cardClass}" onclick="selectStar('${star.name}')">
                        <div class="star-name">${typeIcon} ${star.name_cn}</div>
                        <div class="star-name-en">${star.name}</div>
                        <div class="star-details">
                            <i class="fas fa-compass"></i> æ–¹ä½è§’: ${star.azimuth.toFixed(1)}Â°<br>
                            <i class="fas fa-arrow-up"></i> é«˜åº¦è§’: ${star.altitude.toFixed(1)}Â°
                            ${star.magnitude !== null ? '<br><i class="fas fa-sun"></i> äº®åº¦: ' + star.magnitude.toFixed(2) : ''}
                        </div>
                        ${visibilityBadge}
                    </div>
                `;
            });

            visibleStarsDiv.innerHTML = html;
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ˜Ÿæ˜Ÿåˆ—è¡¨ï¼ˆç”¨äºæœç´¢ç»“æœæˆ–å…¨éƒ¨æ˜¾ç¤ºï¼‰
        function displayAllStarsList(stars) {
            if (stars.length === 0) {
                visibleStarsDiv.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8; font-size: 1.1em;"><i class="fas fa-search"></i> æœªæ‰¾åˆ°åŒ¹é…çš„å¤©ä½“</p>';
                return;
            }
            
            let html = '<h3 style="grid-column: 1/-1; color: #60a5fa; margin-bottom: 10px; font-size: 1.3em;"><i class="fas fa-book"></i> å¤©ä½“åˆ—è¡¨ï¼ˆå…±' + stars.length + 'ä¸ªï¼‰</h3>';
            stars.forEach(star => {
                const cardClass = star.type === 'planet' ? 'star-card planet' : 'star-card';
                const typeIcon = star.type === 'planet' ? '<i class="fas fa-globe"></i>' : '<i class="fas fa-star"></i>';
                const magText = star.magnitude !== null ? `äº®åº¦: ${star.magnitude.toFixed(2)}` : 'è¡Œæ˜Ÿ';
                
                html += `
                    <div class="${cardClass}" onclick="selectStar('${star.name}')">
                        <div class="star-name">${typeIcon} ${star.name_cn}</div>
                        <div class="star-name-en">${star.name}</div>
                        <div class="star-details">${magText}</div>
                    </div>
                `;
            });
            
            visibleStarsDiv.innerHTML = html;
        }

        // é€‰æ‹©æ˜Ÿæ˜Ÿå¹¶è·³è½¬åˆ°è¯¦æƒ…é¡µé¢
        async function selectStar(starName) {
            // è·å–å½“å‰é€‰æ‹©çš„è§‚æµ‹æ—¶é—´
            let url = `/star/${encodeURIComponent(starName)}`;
            if (observationTimeInput.value) {
                const obsTime = new Date(observationTimeInput.value).toISOString();
                url += `?time=${encodeURIComponent(obsTime)}`;
            }
            window.location.href = url;
        }

        // å°†æ–¹ä½è§’è½¬æ¢ä¸ºæ–¹å‘æè¿°
        function azimuthToDirection(azimuth) {
            const directions = [
                { name: 'æ­£åŒ—', range: [348.75, 11.25] },
                { name: 'åŒ—åä¸œ', range: [11.25, 33.75] },
                { name: 'ä¸œåŒ—', range: [33.75, 56.25] },
                { name: 'ä¸œååŒ—', range: [56.25, 78.75] },
                { name: 'æ­£ä¸œ', range: [78.75, 101.25] },
                { name: 'ä¸œåå—', range: [101.25, 123.75] },
                { name: 'ä¸œå—', range: [123.75, 146.25] },
                { name: 'å—åä¸œ', range: [146.25, 168.75] },
                { name: 'æ­£å—', range: [168.75, 191.25] },
                { name: 'å—åè¥¿', range: [191.25, 213.75] },
                { name: 'è¥¿å—', range: [213.75, 236.25] },
                { name: 'è¥¿åå—', range: [236.25, 258.75] },
                { name: 'æ­£è¥¿', range: [258.75, 281.25] },
                { name: 'è¥¿ååŒ—', range: [281.25, 303.75] },
                { name: 'è¥¿åŒ—', range: [303.75, 326.25] },
                { name: 'åŒ—åè¥¿', range: [326.25, 348.75] }
            ];
            
            for (let dir of directions) {
                if (dir.range[0] <= dir.range[1]) {
                    if (azimuth >= dir.range[0] && azimuth < dir.range[1]) {
                        return dir.name;
                    }
                } else {
                    if (azimuth >= dir.range[0] || azimuth < dir.range[1]) {
                        return dir.name;
                    }
                }
            }
            return 'æ­£åŒ—';
        }

        // è·å–ä»°è§’æè¿°
        function getAltitudeDescription(altitude) {
            if (altitude < 10) return 'åœ°å¹³çº¿é™„è¿‘';
            if (altitude < 30) return 'ä½ç©º';
            if (altitude < 60) return 'ä¸­ç©º';
            if (altitude < 80) return 'é«˜ç©º';
            return 'æ¥è¿‘å¤©é¡¶';
        }

        function displayResults(data) {
            const { star_info, best_point, all_points } = data;
            
            const direction = azimuthToDirection(star_info.azimuth);
            const altitudeDesc = getAltitudeDescription(star_info.altitude);

            let html = `
                <div class="star-info">
                    <h2><i class="fas fa-star"></i> ${star_info.name}</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-compass"></i> è§‚æµ‹æ–¹å‘</div>
                            <div class="info-value">${direction}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-location-crosshairs"></i> æ–¹ä½è§’</div>
                            <div class="info-value">${star_info.azimuth.toFixed(1)}Â°</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-arrow-up"></i> ä»°è§’</div>
                            <div class="info-value">${star_info.altitude.toFixed(1)}Â° (${altitudeDesc})</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-map"></i> å¤©ä½“åæ ‡</div>
                            <div class="info-value">RA ${star_info.ra.toFixed(1)}Â° / Dec ${star_info.dec.toFixed(1)}Â°</div>
                        </div>
                    </div>
                </div>

                <div class="recommendations">
                    <h3><i class="fas fa-map-marked-alt"></i> æ¨èè§‚æµ‹ç‚¹ï¼ˆå…± ${all_points.length} ä¸ªï¼‰</h3>
            `;

            all_points.forEach((point, index) => {
                const isBest = index === 0;
                const difficultyText = point.difficulty <= 30 ? 'ç®€å•' : point.difficulty <= 60 ? 'ä¸­ç­‰' : 'å›°éš¾';
                const difficultyIcon = point.difficulty <= 30 ? 'fa-smile' : point.difficulty <= 60 ? 'fa-meh' : 'fa-frown';
                
                html += `
                    <div class="point-card ${isBest ? 'best' : ''}">
                        <div class="point-header">
                            <div class="point-name">
                                ${isBest ? '<i class="fas fa-trophy"></i> ' : `${index + 1}. `}${point.name}
                            </div>
                            <div class="point-score"><i class="fas fa-star"></i> è¯„åˆ†: ${point.score.toFixed(1)}</div>
                        </div>
                        <div class="point-details">
                            <div class="detail-item" style="grid-column: 1/-1; background: rgba(88, 101, 242, 0.15); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 3px solid #5865f2;">
                                <div>
                                    <strong><i class="fas fa-route"></i> è§‚æµ‹æŒ‡å¼•ï¼š</strong><br>
                                    æœ <strong style="color: #60a5fa; font-size: 1.15em;">${direction}</strong> æ–¹å‘ï¼Œä»°è§’ <strong style="color: #60a5fa; font-size: 1.15em;">${star_info.altitude.toFixed(1)}Â°</strong>ï¼ˆ${altitudeDesc}ï¼‰
                                </div>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-map-pin"></i> ç»åº¦: ${point.longitude}Â°
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-map-pin"></i> çº¬åº¦: ${point.latitude}Â°
                            </div>
                            <div class="detail-item">
                                <i class="fas ${difficultyIcon}"></i> éš¾æ˜“åº¦: ${point.difficulty} (${difficultyText})
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-eye"></i> å¯è§‚æµ‹: ${point.view_start}Â° - ${point.view_end}Â°
                            </div>
                        </div>
                        ${isBest ? '<div class="best-badge"><i class="fas fa-award"></i> æœ€ä½³æ¨è</div>' : ''}
                    </div>
                `;
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        let map;
        let wildSpotsLayer = null;

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            // ä¸‰å±±å²›ä¸­å¿ƒåæ ‡
            const center = [31.03, 120.29];
            map = L.map('map-container').setView(center, 14);

            // ä½¿ç”¨æ·±è‰²åœ°å›¾ç“¦ç‰‡
            // ä½¿ç”¨ ArcGIS World Street Map (æ ‡å‡†å½©è‰²åœ°å›¾ï¼ŒWGS84ï¼Œç¨³å®šå¯é )
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: '&copy; Esri',
                maxZoom: 19
            }).addTo(map);

            // è·å–å¹¶æ·»åŠ è§‚æµ‹ç‚¹
            fetch('/api/points')
                .then(response => response.json())
                .then(points => {
                    points.forEach(point => {
                        const marker = L.marker([point.latitude, point.longitude]).addTo(map);
                        
                        // éš¾åº¦é¢œè‰²
                        let difficultyColor = '#10b981'; // ç®€å• - ç»¿è‰²
                        if (point.difficulty > 60) difficultyColor = '#ef4444'; // å›°éš¾ - çº¢è‰²
                        else if (point.difficulty > 30) difficultyColor = '#f59e0b'; // ä¸­ç­‰ - é»„è‰²

                        const popupContent = `
                            <div style="color: #333; min-width: 200px;">
                                <h3 style="margin: 0 0 8px 0; color: #3b82f6;">${point.name}</h3>
                                <p style="margin: 4px 0;"><strong>ç»åº¦:</strong> ${point.longitude}</p>
                                <p style="margin: 4px 0;"><strong>çº¬åº¦:</strong> ${point.latitude}</p>
                                <p style="margin: 4px 0;"><strong>éš¾æ˜“åº¦:</strong> <span style="color: ${difficultyColor}; font-weight: bold;">${point.difficulty}</span></p>
                                <p style="margin: 4px 0;"><strong>è§†è§’:</strong> ${point.view_start}Â° - ${point.view_end}Â°</p>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                    });
                })
                .catch(error => console.error('Error loading points:', error));

            // ç»‘å®šå¯»æ‰¾é‡å¤–ç‚¹æŒ‰é’®äº‹ä»¶
            // const findWildBtn = document.getElementById('findWildBtn');
            // if (findWildBtn) {
            //     findWildBtn.addEventListener('click', loadWildSpots);
            // }
        }

        // åŠ è½½å¤©æ°”æ•°æ®
        async function loadWeather() {
            const container = document.getElementById('weather-container');
            try {
                const response = await fetch('/api/weather');
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error);
                
                // è§‚æ˜Ÿæ¡ä»¶é¢œè‰²
                let conditionColor = '#ef4444'; // å·®
                if (data.stargazing_score >= 80) conditionColor = '#10b981'; // æä½³
                else if (data.stargazing_score >= 60) conditionColor = '#3b82f6'; // è‰¯å¥½
                else if (data.stargazing_score >= 40) conditionColor = '#f59e0b'; // ä¸€èˆ¬
                
                container.innerHTML = `
                    <div class="weather-card" style="border-color: ${conditionColor}; background: rgba(${parseInt(conditionColor.slice(1,3),16)}, ${parseInt(conditionColor.slice(3,5),16)}, ${parseInt(conditionColor.slice(5,7),16)}, 0.1);">
                        <i class="fas fa-star" style="color: ${conditionColor};"></i>
                        <div class="label">è§‚æ˜ŸæŒ‡æ•°</div>
                        <div class="data" style="color: ${conditionColor};">${data.stargazing_score}</div>
                        <div class="condition-badge" style="background: ${conditionColor}; color: #fff;">${data.condition_text}</div>
                    </div>
                    
                    <div class="weather-card">
                        <i class="fas fa-temperature-high"></i>
                        <div class="label">æ°”æ¸©</div>
                        <div class="data">${data.temperature}Â°C</div>
                    </div>
                    
                    <div class="weather-card">
                        <i class="fas fa-cloud"></i>
                        <div class="label">äº‘é‡</div>
                        <div class="data">${data.cloud_cover}%</div>
                    </div>
                    
                    <div class="weather-card">
                        <i class="fas fa-moon"></i>
                        <div class="label">æœˆç›¸</div>
                        <div class="data">${data.moon_phase_text}</div>
                        <div class="label" style="font-size: 0.75em;">${(data.moon_phase * 100).toFixed(0)}% è¢«ç…§äº®</div>
                    </div>
                    
                    <div class="weather-card">
                        <i class="fas fa-wind"></i>
                        <div class="label">é£é€Ÿ</div>
                        <div class="data">${data.wind_speed} km/h</div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Weather error:', error);
                container.innerHTML = `
                    <div class="error" style="grid-column: 1/-1; padding: 15px;">
                        <i class="fas fa-exclamation-triangle"></i> å¤©æ°”æ•°æ®åŠ è½½å¤±è´¥
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            loadWeather();
        });
    </script>
    <script src="{{ url_for('static', filename='js/star-bg.js') }}"></script>
</body>
</html>
