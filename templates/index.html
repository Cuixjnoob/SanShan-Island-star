<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å±±å²›è§‚æ˜Ÿé€‰å€ç³»ç»Ÿ-å¥é¸£æ˜Ÿå…‰</title>
    
    <!-- é¢„è¿æ¥å…³é”®åŸŸå -->
    <link rel="preconnect" href="https://cdn.bootcdn.net">
    
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.js" defer></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js" defer></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/star-bg.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/red-mode.css') }}">
    <style>
        :root {
            /* LeetCode Dark Theme Inspired Colors */
            --lc-bg: #1a1a1a;
            --lc-card-bg: #282828;
            --lc-card-hover: #323232;
            --lc-text-main: #eff1f6;
            --lc-text-sub: #8a8a8a;
            --lc-primary: #ffa116; /* LeetCode Orange */
            --lc-accent: #0a84ff; /* LeetCode Blue */
            --lc-success: #2cbb5d;
            --lc-warning: #ffc01e;
            --lc-danger: #ef4743;
            --lc-border: #3e3e3e;
            --lc-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            --lc-radius: 8px;
            --lc-font: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--lc-font);
            background-color: var(--lc-bg);
            min-height: 100vh;
            color: var(--lc-text-main);
            line-height: 1.6;
            position: relative;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* LeetCodeé£æ ¼å¡ç‰‡é€šç”¨æ ·å¼ */
        .hydro-card {
            background: var(--lc-card-bg);
            border-radius: var(--lc-radius);
            box-shadow: var(--lc-shadow);
            margin-bottom: 20px;
            padding: 24px;
            border: 1px solid transparent; /* LeetCode cards usually don't have borders in dark mode, or very subtle */
        }

        header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            color: var(--lc-text-main);
            font-weight: 600;
        }

        .subtitle {
            font-size: 1.5em;
            color: var(--lc-text-sub);
            font-weight: 400;
        }

        /* ç³»ç»Ÿä¿¡æ¯å¡ç‰‡ç»„ */
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-card {
            background: var(--lc-card-bg);
            padding: 20px;
            border-radius: var(--lc-radius);
            box-shadow: var(--lc-shadow);
            text-align: center;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background: var(--lc-card-hover);
        }

        .info-card h3 {
            font-size: 0.85em;
            color: var(--lc-text-sub);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .info-card .value {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--lc-text-main); /* LeetCode uses white for numbers usually */
        }

        /* å¤©æ°”å¡ç‰‡æ ·å¼ */
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 24px;
        }

        .weather-card {
            background: var(--lc-card-bg);
            padding: 15px;
            border-radius: var(--lc-radius);
            border: 1px solid var(--lc-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .weather-card i {
            font-size: 1.5em;
            margin-bottom: 8px;
            color: var(--lc-primary);
        }

        .weather-card .label {
            font-size: 0.85em;
            color: var(--lc-text-sub);
            margin-bottom: 4px;
        }

        .weather-card .data {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--lc-text-main);
        }

        .condition-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 5px;
        }

        /* è§‚æµ‹ç‚¹åˆ—è¡¨ */
        .points-list {
            background: var(--lc-card-bg);
            border-radius: var(--lc-radius);
            box-shadow: var(--lc-shadow);
            margin-bottom: 24px;
            padding: 24px;
        }

        .points-list h2 {
            font-size: 1.4em;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--lc-border);
            color: var(--lc-text-main);
            font-weight: 600;
        }

        .points-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        /* åœ°å›¾å®¹å™¨æ ·å¼ */
        #map-container {
            height: 400px;
            width: 100%;
            border-radius: var(--lc-radius);
            margin-bottom: 20px;
            z-index: 1;
            border: 1px solid var(--lc-border);
        }

        .point-item {
            background: var(--lc-card-bg);
            padding: 20px;
            border-radius: var(--lc-radius);
            border: 1px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: var(--lc-shadow);
        }

        .point-item:hover {
            background: var(--lc-card-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .point-item h3 {
            color: var(--lc-text-main);
            font-size: 1.1em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .point-item p {
            font-size: 0.9em;
            color: var(--lc-text-sub);
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .point-item p i {
            width: 16px;
            text-align: center;
            color: var(--lc-text-sub);
        }

        /* æœç´¢åŒºåŸŸ */
        .search-section {
            background: var(--lc-card-bg);
            border-radius: var(--lc-radius);
            box-shadow: var(--lc-shadow);
            margin-bottom: 24px;
            padding: 24px;
        }

        .time-selector {
            background: var(--lc-bg);
            padding: 16px;
            border-radius: var(--lc-radius);
            margin-bottom: 20px;
            border: 1px solid var(--lc-border);
        }

        .time-selector h3 {
            font-size: 1em;
            color: var(--lc-text-main);
            margin-bottom: 15px;
            border-bottom: 1px solid var(--lc-border);
            padding-bottom: 10px;
            font-weight: 600;
        }

        .time-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .time-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--lc-text-sub);
        }

        /* è¾“å…¥æ¡†å’ŒæŒ‰é’® */
        input[type="text"], 
        input[type="datetime-local"],
        select {
            background: var(--lc-bg);
            border: 1px solid var(--lc-border);
            color: var(--lc-text-main);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.95em;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, 
        input[type="datetime-local"]:focus,
        select:focus {
            border-color: var(--lc-primary);
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
        }
        
        .search-box select {
            padding: 10px 15px;
            cursor: pointer;
        }

        .btn {
            background: var(--lc-bg);
            color: var(--lc-text-main);
            border: 1px solid var(--lc-border);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: none;
        }

        .btn:hover {
            background: var(--lc-card-hover);
            border-color: var(--lc-text-sub);
        }
        
        /* Primary Button Style */
        .btn-primary, #updateTimeBtn, #refreshBtn {
            background: var(--lc-primary);
            color: #fff; /* Orange bg needs white text */
            border: none;
        }
        
        .btn-primary:hover, #updateTimeBtn:hover, #refreshBtn:hover {
            background: #e59113; /* Darker orange */
            border: none;
        }

        #resetTimeBtn {
            background: var(--lc-bg);
            border: 1px solid var(--lc-border);
        }
        #resetTimeBtn:hover {
            background: var(--lc-card-hover);
        }

        /* æ˜Ÿæ˜Ÿåˆ—è¡¨ */
        .visible-stars-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        .star-card {
            background: var(--lc-bg);
            border: 1px solid var(--lc-border);
            border-radius: var(--lc-radius);
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .star-card:hover {
            border-color: var(--lc-primary);
            background: var(--lc-card-hover);
        }

        .star-card.planet {
            border-left: 3px solid var(--lc-warning);
        }

        .star-name {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--lc-text-main);
            margin-bottom: 4px;
        }

        .star-name-en {
            font-size: 0.85em;
            color: var(--lc-text-sub);
            margin-bottom: 10px;
        }

        .star-details {
            font-size: 0.85em;
            color: var(--lc-text-sub);
            line-height: 1.6;
        }

        .star-altitude {
            display: inline-block;
            margin-top: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            background: var(--lc-bg);
        }

        /* è¦†ç›–ä¹‹å‰çš„æ¸å˜èƒŒæ™¯ï¼Œä½¿ç”¨çº¯è‰²æ ‡ç­¾ */
        .star-altitude[style*="10b981"] { /* æœ€ä½³è§‚æµ‹ */
            background: rgba(44, 187, 93, 0.15) !important;
            color: var(--lc-success);
            border: none;
        }
        .star-altitude[style*="3b82f6"] { /* å¯è§ */
            background: rgba(10, 132, 255, 0.15) !important;
            color: var(--lc-accent);
            border: none;
        }
        .star-altitude[style*="f59e0b"] { /* åœ°å¹³çº¿é™„è¿‘ */
            background: rgba(255, 192, 30, 0.15) !important;
            color: var(--lc-warning);
            border: none;
        }

        /* åŠ è½½å’Œé”™è¯¯çŠ¶æ€ */
        .loading, .error {
            text-align: center;
            padding: 40px;
            color: var(--lc-text-sub);
            background: var(--lc-card-bg);
            border-radius: var(--lc-radius);
        }

        .compass {
            font-size: 2em;
            margin-bottom: 10px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            h1 { font-size: 1.8em; }
            .search-box { flex-direction: column; }
            .time-controls { flex-direction: column; align-items: stretch; }
        }

        /* æŠ˜å åŠŸèƒ½æ ·å¼ */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            transition: color 0.2s;
        }

        .collapsible-header:hover {
            color: var(--lc-primary);
        }

        .collapsible-header .toggle-icon {
            transition: transform 0.3s ease;
            color: var(--lc-text-sub);
        }

        .collapsible-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        /* è§‚æµ‹ç‚¹å¡ç‰‡æŠ˜å æ ·å¼ */
        .point-card {
            position: relative;
        }

        .point-header {
            cursor: pointer;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.02);
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .point-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .point-header .toggle-icon {
            color: var(--lc-text-sub);
            transition: transform 0.3s ease;
        }

        .point-card.collapsed .point-header .toggle-icon {
            transform: rotate(-90deg);
        }

        .point-card .point-details {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
        }

        .point-card.collapsed .point-details {
            max-height: 0;
            opacity: 0;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 20px 10px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .subtitle {
                font-size: 1.2em;
            }
            
            .system-info {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .info-card {
                padding: 15px;
            }
            
            .info-card .value {
                font-size: 1.4em;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .search-box > * {
                width: 100%;
            }
            
            .visible-stars-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âœ¨ ä¸‰å±±å²›è§‚æ˜Ÿé€‰å€ç³»ç»Ÿ</h1>
            <p class="subtitle">å¥é¸£æ˜Ÿå…‰</p>
        </header>

        <div class="system-info">
            <div class="info-card">
                <h3><i class="fas fa-map-marker-alt"></i> è§‚æµ‹ç‚¹æ•°é‡</h3>
                <div class="value" id="pointCount">-</div>
            </div>
            <div class="info-card">
                <h3><i class="fas fa-star"></i> å¯è§å¤©ä½“</h3>
                <div class="value" id="visibleCount">-</div>
            </div>
            <div class="info-card">
                <h3><i class="fas fa-clock"></i> å½“å‰æ—¶é—´</h3>
                <div class="value" id="currentTime" style="font-size: 1.8em;">-</div>
            </div>
            <div class="info-card">
                <h3><i class="fas fa-signal"></i> ç³»ç»ŸçŠ¶æ€</h3>
                <div class="value" id="systemStatus" style="font-size: 1.5em;">è¿è¡Œä¸­</div>
            </div>
        </div>

        <div class="search-section">
            <div class="time-selector">
                <h3><i class="fas fa-clock"></i> è§‚æµ‹æ—¶é—´è®¾ç½®</h3>
                <div class="time-controls">
                    <input type="datetime-local" id="observationTime" />
                    <button id="resetTimeBtn" class="btn" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4);">
                        <span><i class="fas fa-clock"></i> å½“å‰æ—¶é—´</span>
                    </button>
                    <button id="updateTimeBtn" class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);">
                        <span><i class="fas fa-sync-alt"></i> æ›´æ–°æ˜Ÿä½“</span>
                    </button>
                </div>
                <div class="time-info">
                    æŸ¥è¯¢æ—¶é—´: <span id="queryTimeDisplay">-</span>
                </div>
            </div>

            <!-- AHP Settings Section -->
            <div class="time-selector" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; cursor: pointer;" onclick="toggleAhpSettings()">
                    <h3 style="margin: 0; border: none; font-size: 1em;"><i class="fas fa-sliders-h"></i> ä¸ªæ€§åŒ–æƒé‡è®¾ç½® (AHP)</h3>
                    <i class="fas fa-chevron-down" id="ahpIcon"></i>
                </div>
                
                <div id="ahpSettings" style="display: none; padding-top: 15px; margin-top: 15px; border-top: 1px solid var(--lc-border);">
                    <p style="font-size: 0.9em; color: var(--lc-text-sub); margin-bottom: 15px;">
                        è¯·è®¾å®šå„å› ç´ çš„ç»å¯¹é‡è¦æ€§ (1-9)ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—ç›¸å¯¹æƒé‡ï¼š
                    </p>
                    
                    <!-- Location Score -->
                    <div class="ahp-slider-container" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 5px;">
                            <span><i class="fas fa-map-marker-alt"></i> åœ°ç†ä½ç½®åŒ¹é…åº¦</span>
                            <span id="score_loc_val" style="color: var(--lc-primary); font-weight: bold;">5</span>
                        </div>
                        <input type="range" id="score_loc" min="1" max="9" step="1" value="5" style="width: 100%;" oninput="document.getElementById('score_loc_val').textContent = this.value">
                    </div>

                    <!-- View Score -->
                    <div class="ahp-slider-container" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 5px;">
                            <span><i class="fas fa-eye"></i> è§†è§’èŒƒå›´</span>
                            <span id="score_view_val" style="color: var(--lc-primary); font-weight: bold;">5</span>
                        </div>
                        <input type="range" id="score_view" min="1" max="9" step="1" value="5" style="width: 100%;" oninput="document.getElementById('score_view_val').textContent = this.value">
                    </div>

                    <!-- Difficulty Score -->
                    <div class="ahp-slider-container" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 5px;">
                            <span><i class="fas fa-hiking"></i> äº¤é€šéš¾æ˜“ç¨‹åº¦</span>
                            <span id="score_diff_val" style="color: var(--lc-primary); font-weight: bold;">5</span>
                        </div>
                        <input type="range" id="score_diff" min="1" max="9" step="1" value="5" style="width: 100%;" oninput="document.getElementById('score_diff_val').textContent = this.value">
                    </div>

                    <!-- Light Pollution Score -->
                    <div class="ahp-slider-container">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 5px;">
                            <span><i class="fas fa-lightbulb"></i> å…‰æ±¡æŸ“æŒ‡æ•°</span>
                            <span id="score_lp_val" style="color: var(--lc-primary); font-weight: bold;">5</span>
                        </div>
                        <input type="range" id="score_lp" min="1" max="9" step="1" value="5" style="width: 100%;" oninput="document.getElementById('score_lp_val').textContent = this.value">
                    </div>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢æ˜Ÿæ˜Ÿåç§°ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰..." autocomplete="off">
                
                <select id="typeFilter">
                    <option value="all">ğŸª æ‰€æœ‰ç±»å‹</option>
                    <option value="star">âœ¨ æ’æ˜Ÿ</option>
                    <option value="planet">ğŸŒ è¡Œæ˜Ÿ</option>
                </select>
                
                <select id="toolFilter">
                    <option value="all">ğŸ”­ æ‰€æœ‰å·¥å…·</option>
                    <option value="naked">ğŸ‘€ è‚‰çœ¼å¯è§</option>
                </select>

                <button id="showAllBtn" class="btn"><span><i class="fas fa-th"></i> æ˜¾ç¤ºå…¨éƒ¨</span></button>
                <button id="refreshBtn" class="btn"><span><i class="fas fa-sync-alt"></i> åˆ·æ–°å¯è§</span></button>
            </div>
            
            <div id="visibleStars" class="visible-stars-grid"></div>
        </div>

        <div id="results" class="results-section"></div>

        <div class="hydro-card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h2><i class="fas fa-cloud-sun"></i> å®æ—¶å¤©æ°”ä¸è§‚æ˜Ÿæ¡ä»¶</h2>
            </div>
            <div id="weather-container" class="weather-grid">
                <div class="loading" style="grid-column: 1/-1; padding: 20px;">
                    <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è·å–å¤©æ°”æ•°æ®...
                </div>
            </div>
            <!-- å¤©æ°”è¶‹åŠ¿å›¾è¡¨ -->
            <div id="weather-chart" style="width: 100%; height: 300px; margin-top: 20px; display: none;"></div>
        </div>

        <div class="hydro-card">
            <div class="card-header">
                <h2><i class="fas fa-map-marked-alt"></i> è§‚æµ‹ç‚¹åœ°å›¾</h2>
            </div>
            <div id="map-container"></div>
        </div>

        <div class="points-list">
            <h2 class="collapsible-header" onclick="toggleCollapse(this)">
                <i class="fas fa-chevron-down toggle-icon"></i>
                <span><i class="fas fa-location-dot"></i> è§‚æµ‹ç‚¹åˆ—è¡¨</span>
            </h2>
            <div id="pointsList" class="points-grid collapsible-content"></div>
        </div>

        <footer style="text-align: center; margin-top: 40px; padding: 20px; color: var(--lc-text-sub); border-top: 1px solid var(--lc-border);">
            <p style="margin-bottom: 10px; font-size: 0.9em;">Presented by</p>
            <p><i class="fas fa-users"></i> å´”è¡Œéª¥ æ½˜å½¦å® ç‹æ™Ÿç‘„ ä¸¥ä»¥æ­£ èµµæ³Šé’§ èµµå‘¨éºŸ</p>
            <p style="margin-top: 15px; font-size: 0.8em; cursor: pointer; opacity: 0.7;" onclick="toggleLog()">
                <i class="fas fa-history"></i> æ›´æ–°æ—¥å¿—
            </p>
        </footer>

        <!-- Log Modal -->
        <div id="logModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--lc-card-bg); padding: 20px; border-radius: var(--lc-radius); max-width: 500px; width: 90%; position: relative; box-shadow: var(--lc-shadow);">
                <span onclick="toggleLog()" style="position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 1.5em; color: var(--lc-text-sub);">&times;</span>
                <h3 style="margin-bottom: 15px; border-bottom: 1px solid var(--lc-border); padding-bottom: 10px;"><i class="fas fa-history"></i> æ›´æ–°æ—¥å¿—</h3>
                <ul style="list-style: none; padding-left: 0;">
                    {% if logs %}
                        {% for log in logs %}
                        <li style="margin-bottom: 8px; color: var(--lc-text-sub);">
                            <span style="color: var(--lc-primary); font-weight: bold; margin-right: 10px;">{{ log.date }}</span> {{ log.content }}
                        </li>
                        {% endfor %}
                    {% else %}
                        <li style="margin-bottom: 8px; color: var(--lc-text-sub);">æš‚æ— æ›´æ–°æ—¥å¿—</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const showAllBtn = document.getElementById('showAllBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const updateTimeBtn = document.getElementById('updateTimeBtn');
        const resetTimeBtn = document.getElementById('resetTimeBtn');
        const observationTimeInput = document.getElementById('observationTime');
        const queryTimeDisplay = document.getElementById('queryTimeDisplay');
        const resultsDiv = document.getElementById('results');
        const visibleStarsDiv = document.getElementById('visibleStars');
        const typeFilter = document.getElementById('typeFilter');
        const toolFilter = document.getElementById('toolFilter');
        
        let allStarsData = []; // å­˜å‚¨æ‰€æœ‰æ˜Ÿæ˜Ÿæ•°æ®
        let currentStarsData = []; // å½“å‰æ˜¾ç¤ºçš„æ˜Ÿæ˜Ÿæ•°æ®ï¼ˆå¯è§æˆ–å…¨éƒ¨ï¼‰
        let currentMode = 'visible'; // 'visible' æˆ– 'all'

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initializeObservationTime();
            loadSystemInfo();
            loadVisibleStars();
            loadAllStars(); // é¢„åŠ è½½æ‰€æœ‰æ˜Ÿæ˜Ÿæ•°æ®
            initMap(); // åˆå§‹åŒ–åœ°å›¾
            updateTime();
            setInterval(updateTime, 1000); // æ¯ç§’æ›´æ–°æ—¶é—´
        });

        // ç»Ÿä¸€è¿‡æ»¤å‡½æ•°
        function applyFilters() {
            const query = searchInput.value.trim().toLowerCase();
            const type = typeFilter.value;
            const tool = toolFilter.value;

            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œç›´æ¥è¿”å›
            if (!currentStarsData || currentStarsData.length === 0) return;

            const filtered = currentStarsData.filter(star => {
                // 1. æ–‡æœ¬æœç´¢
                const matchText = star.name.toLowerCase().includes(query) || star.name_cn.includes(query);
                if (!matchText) return false;

                // 2. ç±»å‹è¿‡æ»¤
                if (type !== 'all' && star.type !== type) return false;

                // 3. å·¥å…·è¿‡æ»¤
                if (tool !== 'all') {
                    // è¡Œæ˜Ÿé€šå¸¸å¾ˆäº®ï¼Œè§†ä¸ºè‚‰çœ¼å¯è§ï¼ˆé™¤éç‰¹åˆ«æš—ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
                    // å¦‚æœ magnitude ä¸º null (è¡Œæ˜Ÿ)ï¼Œè®¾ä¸º -100 (æäº®)
                    const mag = star.magnitude !== null ? star.magnitude : -100; 
                    
                    if (tool === 'naked') {
                        // è‚‰çœ¼å¯è§: æ¨¡æ‹ŸåŸå¸‚ç¯å¢ƒï¼Œåªæ˜¾ç¤ºè¾ƒäº®çš„æ˜Ÿæ˜Ÿ (< 2.0)
                        if (mag >= 2.0) return false;
                    }
                }

                return true;
            });

            if (currentMode === 'visible') {
                displayVisibleStars(filtered);
            } else {
                displayAllStarsList(filtered);
            }
        }

        // ç›‘å¬è¿‡æ»¤å™¨å˜åŒ–
        typeFilter.addEventListener('change', applyFilters);
        toolFilter.addEventListener('change', applyFilters);
        searchInput.addEventListener('input', applyFilters);

        // åˆ‡æ¢æ›´æ–°æ—¥å¿—æ˜¾ç¤º
        function toggleLog() {
            const modal = document.getElementById('logModal');
            if (modal.style.display === 'none' || modal.style.display === '') {
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        // å½©è›‹æ—¥æœŸé…ç½®
        const memorableDates = {
            '04-12': { year: 1961, title: 'å°¤é‡Œä¹‹å¤œ', content: 'å°¤é‡ŒÂ·åŠ åŠ æ—æˆä¸ºç¬¬ä¸€ä¸ªè¿›å…¥å¤ªç©ºçš„äººç±»ï¼ğŸš€' },
            '04-24': { year: 1970, title: 'ä¸­å›½èˆªå¤©æ—¥', content: 'ä¸­å›½ç¬¬ä¸€é¢—äººé€ å«æ˜Ÿâ€œä¸œæ–¹çº¢ä¸€å·â€å‘å°„æˆåŠŸï¼ğŸ›°ï¸' },
            '07-20': { year: 1969, title: 'äººç±»æœˆçƒæ—¥', content: 'é˜¿æ³¢ç½—11å·æˆåŠŸç™»æœˆï¼Œäººç±»è¿ˆå‡ºäº†ä¸€å¤§æ­¥ï¼ğŸŒ•' },
            '10-04': { year: 1957, title: 'å¤ªç©ºæ—¶ä»£å¼€å¯', content: 'ç¬¬ä¸€é¢—äººé€ å«æ˜Ÿæ–¯æ™®ç‰¹å°¼å…‹1å·å‘å°„æˆåŠŸï¼ğŸ“¡' },
            '10-15': { year: 2003, title: 'ä¸­å›½è½½äººèˆªå¤©', content: 'ç¥èˆŸäº”å·å‘å°„æˆåŠŸï¼Œæ¨åˆ©ä¼Ÿæˆä¸ºä¸­å›½é¦–ä½èˆªå¤©å‘˜ï¼ğŸ‘¨â€ğŸš€' },
            '12-25': { year: 2021, title: 'éŸ¦ä¼¯æœ›è¿œé•œå‘å°„', content: 'è©¹å§†æ–¯Â·éŸ¦ä¼¯å¤ªç©ºæœ›è¿œé•œå‘å°„å‡ç©ºï¼Œå¼€å¯æ·±ç©ºæ¢ç´¢æ–°çºªå…ƒï¼ğŸ”­' }
        };

        function checkEasterEgg(dateStr) {
            if (!dateStr) return;
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const key = `${month}-${day}`;
            
            if (memorableDates[key]) {
                const info = memorableDates[key];
                // åªæœ‰å½“å¹´ä»½å¤§äºç­‰äºäº‹ä»¶å¹´ä»½æ—¶æ‰è§¦å‘
                if (year >= info.year) {
                    const anniversary = year - info.year;
                    showEasterEgg(info, anniversary);
                }
            }
        }

        function showEasterEgg(info, anniversary) {
            // ç§»é™¤å·²å­˜åœ¨çš„å½©è›‹
            const existing = document.getElementById('easter-egg-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'easter-egg-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                animation: fadeIn 0.5s;
            `;
            
            const titleHtml = anniversary > 0 
                ? `${info.title}<div style="font-size:0.6em; margin-top:5px; color:#ffa116; opacity:0.8;">${anniversary}å‘¨å¹´çºªå¿µ</div>`
                : info.title;

            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                    border: 2px solid #ffa116;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 400px;
                    text-align: center;
                    box-shadow: 0 0 20px rgba(255, 161, 22, 0.3);
                    transform: scale(0.9);
                    animation: popIn 0.5s forwards;
                ">
                    <div style="font-size: 3em; margin-bottom: 15px;">ğŸ‰</div>
                    <h2 style="color: #ffa116; margin-bottom: 15px; line-height: 1.2;">${titleHtml}</h2>
                    <p style="color: #eff1f6; line-height: 1.6; margin-bottom: 20px;">${info.year}å¹´çš„ä»Šå¤©ï¼Œ${info.content}</p>
                    <button onclick="document.getElementById('easter-egg-modal').remove()" class="btn btn-primary" style="width: 100%;">
                        æˆ‘çŸ¥é“äº†
                    </button>
                </div>
                <style>
                    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
                </style>
            `;
            
            document.body.appendChild(modal);
        }

        // åˆå§‹åŒ–è§‚æµ‹æ—¶é—´ä¸ºå½“å‰æ—¶é—´
        function initializeObservationTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            observationTimeInput.value = localDateTime;
            updateQueryTimeDisplay();
            checkEasterEgg(localDateTime);
        }

        // æ›´æ–°æŸ¥è¯¢æ—¶é—´æ˜¾ç¤º
        function updateQueryTimeDisplay() {
            if (observationTimeInput.value) {
                const dt = new Date(observationTimeInput.value);
                queryTimeDisplay.textContent = dt.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }
        }

        // ç›‘å¬æ—¶é—´é€‰æ‹©å˜åŒ– - åªæ›´æ–°æ˜¾ç¤ºï¼Œä¸è‡ªåŠ¨åˆ·æ–°
        observationTimeInput.addEventListener('change', () => {
            updateQueryTimeDisplay();
        });

        // é‡ç½®ä¸ºå½“å‰æ—¶é—´æŒ‰é’®
        resetTimeBtn.addEventListener('click', () => {
            initializeObservationTime();
        });

        // æ›´æ–°æ˜Ÿä½“æŒ‰é’® - ä½¿ç”¨é€‰å®šçš„æ—¶é—´åˆ·æ–°å¯è§æ˜Ÿä½“
        updateTimeBtn.addEventListener('click', () => {
            checkEasterEgg(observationTimeInput.value);
            if (currentMode === 'visible') {
                loadVisibleStars();
            }
        });

        // åˆ·æ–°æŒ‰é’® - åˆ·æ–°å¯è§æ˜Ÿæ˜Ÿ
        refreshBtn.addEventListener('click', () => {
            currentMode = 'visible';
            searchInput.value = '';
            typeFilter.value = 'all';
            toolFilter.value = 'all';
            resultsDiv.style.display = 'none';
            loadSystemInfo();
            loadVisibleStars();
        });
        
        // æ˜¾ç¤ºå…¨éƒ¨æŒ‰é’®
        showAllBtn.addEventListener('click', () => {
            currentMode = 'all';
            searchInput.value = '';
            typeFilter.value = 'all';
            toolFilter.value = 'all';
            resultsDiv.style.display = 'none';
            displayAllStars();
        });
        
        // æœç´¢åŠŸèƒ½ (å·²æ•´åˆåˆ° applyFilters)
        // searchInput.addEventListener('input', ...);

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
            document.getElementById('currentTime').textContent = timeStr;
        }

        // åŠ è½½ç³»ç»Ÿä¿¡æ¯
        async function loadSystemInfo() {
            try {
                const response = await fetch('/api/points');
                const data = await response.json();
                
                if (response.ok && Array.isArray(data)) {
                    document.getElementById('pointCount').textContent = data.length;
                    document.getElementById('systemStatus').textContent = 'âœ“ æ­£å¸¸';
                    document.getElementById('systemStatus').style.color = '#00ff00';
                    
                    // æ˜¾ç¤ºè§‚æµ‹ç‚¹åˆ—è¡¨
                    displayPointsList(data);
                }
            } catch (error) {
                document.getElementById('systemStatus').textContent = 'âœ— å¼‚å¸¸';
                document.getElementById('systemStatus').style.color = '#ff0000';
            }
        }

        // æ˜¾ç¤ºè§‚æµ‹ç‚¹åˆ—è¡¨
        function displayPointsList(points) {
            const pointsListDiv = document.getElementById('pointsList');
            
            if (points.length === 0) {
                pointsListDiv.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #94a3b8;">æ— è§‚æµ‹ç‚¹æ•°æ®</p>';
                return;
            }

            let html = '';
            points.forEach(point => {
                // å…‰æ±¡æŸ“é¢œè‰²
                let lpColor = '#10b981'; // ç»¿è‰² (å¥½)
                if (point.bortle >= 5) lpColor = '#f59e0b'; // é»„è‰² (ä¸€èˆ¬)
                if (point.bortle >= 7) lpColor = '#ef4444'; // çº¢è‰² (å·®)

                html += `
                    <div class="point-item" onclick="window.location.href='/point/${encodeURIComponent(point.name)}'">
                        <h3><i class="fas fa-map-pin"></i> ${point.name}</h3>
                        <p><i class="fas fa-compass"></i> ç»åº¦: ${point.longitude.toFixed(3)}Â°</p>
                        <p><i class="fas fa-compass"></i> çº¬åº¦: ${point.latitude.toFixed(3)}Â°</p>
                        <p><i class="fas fa-hiking"></i> éš¾åº¦: ${point.difficulty}</p>
                        <p><i class="fas fa-lightbulb"></i> å…‰æ±¡æŸ“: <span style="color: ${lpColor}; font-weight: bold;">Bortle ${point.bortle}</span> (SQM ${point.sqm})</p>
                        <p><i class="fas fa-eye"></i> è§†è§’: ${point.view_start}Â° - ${point.view_end}Â°</p>
                    </div>
                `;
            });
            
            pointsListDiv.innerHTML = html;
        }

        // åŠ è½½æ‰€æœ‰æ˜Ÿæ˜Ÿæ•°æ®ï¼ˆç”¨äºæœç´¢ï¼‰
        async function loadAllStars() {
            try {
                const response = await fetch('/api/all-stars');
                const data = await response.json();
                if (response.ok) {
                    allStarsData = data.celestial_objects;
                }
            } catch (error) {
                console.error('åŠ è½½æ‰€æœ‰æ˜Ÿæ˜Ÿæ•°æ®å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ˜Ÿæ˜Ÿï¼ˆä¸ç®¡æ˜¯å¦å¯è§ï¼‰
        async function displayAllStars() {
            visibleStarsDiv.innerHTML = '<div class="loading" style="grid-column: 1/-1;"><div class="compass">âœ¨</div><p>æ­£åœ¨åŠ è½½æ‰€æœ‰å¤©ä½“æ•°æ®...</p></div>';
            
            if (allStarsData.length === 0) {
                await loadAllStars();
            }
            
            currentStarsData = allStarsData;
            applyFilters();
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(filtered, query) {
            if (filtered.length === 0) {
                visibleStarsDiv.innerHTML = `<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8; font-size: 1.1em;"><i class="fas fa-search"></i> æœªæ‰¾åˆ°åŒ…å« "${query}" çš„å¤©ä½“</p>`;
                return;
            }
            
            let html = `<h3 style="grid-column: 1/-1; color: #60a5fa; margin-bottom: 10px; font-size: 1.3em;"><i class="fas fa-search"></i> æœç´¢ç»“æœï¼ˆå…±${filtered.length}ä¸ªï¼‰</h3>`;
            filtered.forEach(star => {
                const cardClass = star.type === 'planet' ? 'star-card planet' : 'star-card';
                const typeIcon = star.type === 'planet' ? '<i class="fas fa-globe"></i>' : '<i class="fas fa-star"></i>';
                const magText = star.magnitude !== null ? `äº®åº¦: ${star.magnitude.toFixed(2)}` : 'è¡Œæ˜Ÿ';
                
                html += `
                    <div class="${cardClass}" onclick="selectStar('${star.name}')">
                        <div class="star-name">${typeIcon} ${star.name_cn}</div>
                        <div class="star-name-en">${star.name}</div>
                        <div class="star-details">${magText}</div>
                    </div>
                `;
            });
            
            visibleStarsDiv.innerHTML = html;
        }

        async function loadVisibleStars() {
            visibleStarsDiv.innerHTML = '<div class="loading" style="grid-column: 1/-1;"><div class="compass">âœ¨</div><p>æ­£åœ¨åŠ è½½å®æ—¶æ˜Ÿç©ºæ•°æ®...</p></div>';
            currentMode = 'visible';
            showAllBtn.textContent = 'æ˜¾ç¤ºå…¨éƒ¨';

            try {
                console.log('å¼€å§‹åŠ è½½å¯è§æ˜Ÿæ˜Ÿ...');
                
                // è·å–é€‰å®šçš„è§‚æµ‹æ—¶é—´
                let url = '/api/visible-stars?min_altitude=0';
                if (observationTimeInput.value) {
                    const obsTime = new Date(observationTimeInput.value).toISOString();
                    url += `&obs_time=${encodeURIComponent(obsTime)}`;
                    console.log('ä½¿ç”¨è§‚æµ‹æ—¶é—´:', obsTime);
                }
                
                const response = await fetch(url);
                console.log('å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('å“åº”æ•°æ®:', data);

                if (!response.ok) {
                    throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                }

                currentStarsData = data.stars; // ä¿å­˜å½“å‰æ•°æ®
                applyFilters(); // åº”ç”¨è¿‡æ»¤å™¨æ˜¾ç¤º
                
                // æ›´æ–°å¯è§å¤©ä½“æ•°é‡
                document.getElementById('visibleCount').textContent = data.count || data.stars.length;
            } catch (error) {
                console.error('åŠ è½½é”™è¯¯:', error);
                visibleStarsDiv.innerHTML = `<div class="error" style="grid-column: 1/-1;"><i class="fas fa-exclamation-triangle"></i> åŠ è½½å¤±è´¥: ${error.message}</div>`;
                document.getElementById('visibleCount').textContent = '0';
            }
        }

        function displayVisibleStars(stars) {
            if (stars.length === 0) {
                visibleStarsDiv.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8; font-size: 1.1em;"><i class="fas fa-moon"></i> å½“å‰æ— å¯è§å¤©ä½“</p>';
                return;
            }

            let html = `
                <h3 class="collapsible-header" onclick="toggleCollapse(this)" style="grid-column: 1/-1; color: #60a5fa; margin-bottom: 15px; font-size: 1.3em;">
                    <i class="fas fa-chevron-down toggle-icon"></i>
                    <span><i class="fas fa-eye"></i> å½“å‰å¯è§å¤©ä½“ï¼ˆå…±${stars.length}ä¸ªï¼‰</span>
                </h3>
                <div class="collapsible-content visible-stars-grid" style="grid-column: 1/-1; margin-top: 0;">
            `;
            
            stars.forEach(star => {
                const cardClass = star.type === 'planet' ? 'star-card planet' : 'star-card';
                const typeIcon = star.type === 'planet' ? '<i class="fas fa-globe"></i>' : '<i class="fas fa-star"></i>';
                
                // æ ¹æ®é«˜åº¦è§’åˆ¤æ–­å¯è§æ€§ç­‰çº§
                let visibilityBadge = '';
                if (star.altitude >= 30) {
                    visibilityBadge = '<span class="star-altitude" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%;"><i class="fas fa-circle-check"></i> æœ€ä½³è§‚æµ‹</span>';
                } else if (star.altitude >= 15) {
                    visibilityBadge = '<span class="star-altitude" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%;"><i class="fas fa-eye"></i> å¯è§</span>';
                } else {
                    visibilityBadge = '<span class="star-altitude" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%;"><i class="fas fa-triangle-exclamation"></i> åœ°å¹³çº¿é™„è¿‘</span>';
                }
                
                html += `
                    <div class="${cardClass}" onclick="selectStar('${star.name}')">
                        <div class="star-name">${typeIcon} ${star.name_cn}</div>
                        <div class="star-name-en">${star.name}</div>
                        <div class="star-details">
                            <i class="fas fa-compass"></i> æ–¹ä½è§’: ${star.azimuth.toFixed(1)}Â°<br>
                            <i class="fas fa-arrow-up"></i> é«˜åº¦è§’: ${star.altitude.toFixed(1)}Â°
                            ${star.magnitude !== null ? '<br><i class="fas fa-sun"></i> äº®åº¦: ' + star.magnitude.toFixed(2) : ''}
                        </div>
                        ${visibilityBadge}
                    </div>
                `;
            });

            html += '</div>';
            visibleStarsDiv.innerHTML = html;
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ˜Ÿæ˜Ÿåˆ—è¡¨ï¼ˆç”¨äºæœç´¢ç»“æœæˆ–å…¨éƒ¨æ˜¾ç¤ºï¼‰
        function displayAllStarsList(stars) {
            if (stars.length === 0) {
                visibleStarsDiv.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8; font-size: 1.1em;"><i class="fas fa-search"></i> æœªæ‰¾åˆ°åŒ¹é…çš„å¤©ä½“</p>';
                return;
            }
            
            let html = `
                <h3 class="collapsible-header" onclick="toggleCollapse(this)" style="grid-column: 1/-1; color: #60a5fa; margin-bottom: 10px; font-size: 1.3em;">
                    <i class="fas fa-chevron-down toggle-icon"></i>
                    <span><i class="fas fa-book"></i> å¤©ä½“åˆ—è¡¨ï¼ˆå…±${stars.length}ä¸ªï¼‰</span>
                </h3>
                <div class="collapsible-content visible-stars-grid" style="grid-column: 1/-1; margin-top: 0;">
            `;
            
            stars.forEach(star => {
                const cardClass = star.type === 'planet' ? 'star-card planet' : 'star-card';
                const typeIcon = star.type === 'planet' ? '<i class="fas fa-globe"></i>' : '<i class="fas fa-star"></i>';
                const magText = star.magnitude !== null ? `äº®åº¦: ${star.magnitude.toFixed(2)}` : 'è¡Œæ˜Ÿ';
                
                html += `
                    <div class="${cardClass}" onclick="selectStar('${star.name}')">
                        <div class="star-name">${typeIcon} ${star.name_cn}</div>
                        <div class="star-name-en">${star.name}</div>
                        <div class="star-details">${magText}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            visibleStarsDiv.innerHTML = html;
        }

        // AHP ç›¸å…³å‡½æ•°
        function toggleAhpSettings() {
            const settings = document.getElementById('ahpSettings');
            const icon = document.getElementById('ahpIcon');
            if (settings.style.display === 'none') {
                settings.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                settings.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        function updateAhpLabel(input, labelId, leftName, rightName) {
            // æ­¤å‡½æ•°ä¸å†ä½¿ç”¨ï¼Œä¿ç•™ä¸ºç©ºä»¥é˜²æŠ¥é”™
        }

        // é€‰æ‹©æ˜Ÿæ˜Ÿå¹¶è·³è½¬åˆ°è¯¦æƒ…é¡µé¢
        async function selectStar(starName) {
            // è·å–å½“å‰é€‰æ‹©çš„è§‚æµ‹æ—¶é—´
            let url = `/star/${encodeURIComponent(starName)}`;
            const params = new URLSearchParams();
            
            if (observationTimeInput.value) {
                const obsTime = new Date(observationTimeInput.value).toISOString();
                params.append('time', obsTime);
            }
            
            // è·å–AHPç»å¯¹åˆ†æ•°å¹¶ä¼ é€’
            const score_loc = document.getElementById('score_loc').value;
            const score_view = document.getElementById('score_view').value;
            const score_diff = document.getElementById('score_diff').value;
            const score_lp = document.getElementById('score_lp').value;
            
            // åªæœ‰å½“åˆ†æ•°ä¸æ˜¯é»˜è®¤å€¼(5)æ—¶æ‰ä¼ é€’ï¼Œæˆ–è€…æ€»æ˜¯ä¼ é€’
            if (score_loc != 5 || score_view != 5 || score_diff != 5 || score_lp != 5) {
                params.append('score_loc', score_loc);
                params.append('score_view', score_view);
                params.append('score_diff', score_diff);
                params.append('score_lp', score_lp);
            }
            
            const queryString = params.toString();
            if (queryString) {
                url += `?${queryString}`;
            }
            
            window.location.href = url;
        }

        // å°†æ–¹ä½è§’è½¬æ¢ä¸ºæ–¹å‘æè¿°
        function azimuthToDirection(azimuth) {
            const directions = [
                { name: 'æ­£åŒ—', range: [348.75, 11.25] },
                { name: 'åŒ—åä¸œ', range: [11.25, 33.75] },
                { name: 'ä¸œåŒ—', range: [33.75, 56.25] },
                { name: 'ä¸œååŒ—', range: [56.25, 78.75] },
                { name: 'æ­£ä¸œ', range: [78.75, 101.25] },
                { name: 'ä¸œåå—', range: [101.25, 123.75] },
                { name: 'ä¸œå—', range: [123.75, 146.25] },
                { name: 'å—åä¸œ', range: [146.25, 168.75] },
                { name: 'æ­£å—', range: [168.75, 191.25] },
                { name: 'å—åè¥¿', range: [191.25, 213.75] },
                { name: 'è¥¿å—', range: [213.75, 236.25] },
                { name: 'è¥¿åå—', range: [236.25, 258.75] },
                { name: 'æ­£è¥¿', range: [258.75, 281.25] },
                { name: 'è¥¿ååŒ—', range: [281.25, 303.75] },
                { name: 'è¥¿åŒ—', range: [303.75, 326.25] },
                { name: 'åŒ—åè¥¿', range: [326.25, 348.75] }
            ];
            
            for (let dir of directions) {
                if (dir.range[0] <= dir.range[1]) {
                    if (azimuth >= dir.range[0] && azimuth < dir.range[1]) {
                        return dir.name;
                    }
                } else {
                    if (azimuth >= dir.range[0] || azimuth < dir.range[1]) {
                        return dir.name;
                    }
                }
            }
            return 'æ­£åŒ—';
        }

        // è·å–ä»°è§’æè¿°
        function getAltitudeDescription(altitude) {
            if (altitude < 10) return 'åœ°å¹³çº¿é™„è¿‘';
            if (altitude < 30) return 'ä½ç©º';
            if (altitude < 60) return 'ä¸­ç©º';
            if (altitude < 80) return 'é«˜ç©º';
            return 'æ¥è¿‘å¤©é¡¶';
        }

        function displayResults(data) {
            const { star_info, best_point, all_points } = data;
            
            const direction = azimuthToDirection(star_info.azimuth);
            const altitudeDesc = getAltitudeDescription(star_info.altitude);

            let html = `
                <div class="star-info">
                    <h2><i class="fas fa-star"></i> ${star_info.name}</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-compass"></i> è§‚æµ‹æ–¹å‘</div>
                            <div class="info-value">${direction}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-location-crosshairs"></i> æ–¹ä½è§’</div>
                            <div class="info-value">${star_info.azimuth.toFixed(1)}Â°</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-arrow-up"></i> ä»°è§’</div>
                            <div class="info-value">${star_info.altitude.toFixed(1)}Â° (${altitudeDesc})</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-map"></i> å¤©ä½“åæ ‡</div>
                            <div class="info-value">RA ${star_info.ra.toFixed(1)}Â° / Dec ${star_info.dec.toFixed(1)}Â°</div>
                        </div>
                    </div>
                </div>

                <div class="recommendations">
                    <h3 class="collapsible-header" onclick="toggleCollapse(this)">
                        <i class="fas fa-chevron-down toggle-icon"></i>
                        <span><i class="fas fa-map-marked-alt"></i> æ¨èè§‚æµ‹ç‚¹ï¼ˆå…± ${all_points.length} ä¸ªï¼‰</span>
                    </h3>
                    <div class="collapsible-content">
            `;

            all_points.forEach((point, index) => {
                const isBest = index === 0;
                const difficultyText = point.difficulty;
                let difficultyIcon = 'fa-smile';
                if (point.difficulty === 'å›°éš¾') difficultyIcon = 'fa-frown';
                else if (point.difficulty === 'ä¸­ç­‰') difficultyIcon = 'fa-meh';
                
                const isExpanded = index === 0; // é»˜è®¤åªå±•å¼€ç¬¬ä¸€ä¸ª
                html += `
                    <div class="point-card ${isBest ? 'best' : ''} ${isExpanded ? '' : 'collapsed'}">
                        <div class="point-header" onclick="togglePointCard(this)">
                            <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                                <div class="point-name">
                                    ${isBest ? '<i class="fas fa-trophy"></i> ' : `${index + 1}. `}${point.name}
                                </div>
                                <div class="point-score"><i class="fas fa-star"></i> è¯„åˆ†: ${point.score.toFixed(1)}</div>
                            </div>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                        <div class="point-details">
                            <div class="detail-item" style="grid-column: 1/-1; background: rgba(88, 101, 242, 0.15); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 3px solid #5865f2;">
                                <div>
                                    <strong><i class="fas fa-route"></i> è§‚æµ‹æŒ‡å¼•ï¼š</strong><br>
                                    æœ <strong style="color: #60a5fa; font-size: 1.15em;">${direction}</strong> æ–¹å‘ï¼Œä»°è§’ <strong style="color: #60a5fa; font-size: 1.15em;">${star_info.altitude.toFixed(1)}Â°</strong>ï¼ˆ${altitudeDesc}ï¼‰
                                </div>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-map-pin"></i> ç»åº¦: ${point.longitude}Â°
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-map-pin"></i> çº¬åº¦: ${point.latitude}Â°
                            </div>
                            <div class="detail-item">
                                <i class="fas ${difficultyIcon}"></i> äº¤é€šéš¾æ˜“ç¨‹åº¦: ${point.difficulty}
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-eye"></i> å¯è§‚æµ‹: ${point.view_start}Â° - ${point.view_end}Â°
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-lightbulb"></i> å…‰æ±¡æŸ“æŒ‡æ•°: Bortle ${point.bortle || '-'} (SQM ${point.sqm || '-'})
                            </div>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 10px; justify-content: center;" onclick="window.location.href='/point/${encodeURIComponent(point.name)}'">
                                <i class="fas fa-info-circle"></i> æŸ¥çœ‹è§‚æµ‹ç‚¹è¯¦æƒ…
                            </button>
                        </div>
                        ${isBest ? '<div class="best-badge"><i class="fas fa-award"></i> æœ€ä½³æ¨è</div>' : ''}
                    </div>
                `;
            });

            html += '</div></div>'; // å…³é—­ collapsible-content å’Œ recommendations
            resultsDiv.innerHTML = html;
        }

        let map;
        let wildSpotsLayer = null;

        // åˆ‡æ¢æŠ˜å çŠ¶æ€
        function toggleCollapse(header) {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            if (content && content.classList.contains('collapsible-content')) {
                content.classList.toggle('collapsed');
            }
        }

        // åˆ‡æ¢è§‚æµ‹ç‚¹å¡ç‰‡æŠ˜å çŠ¶æ€
        function togglePointCard(header) {
            const card = header.parentElement;
            card.classList.toggle('collapsed');
        }

        // åæ ‡è½¬æ¢å·¥å…·å‡½æ•° (WGS84 -> GCJ02)
        function wgs84togcj02(lng, lat) {
            var PI = 3.1415926535897932384626;
            var a = 6378245.0;
            var ee = 0.00669342162296594323;
            if (out_of_china(lng, lat)) {
                return [lat, lng];
            }
            var dlat = transformlat(lng - 105.0, lat - 35.0);
            var dlng = transformlng(lng - 105.0, lat - 35.0);
            var radlat = lat / 180.0 * PI;
            var magic = Math.sin(radlat);
            magic = 1 - ee * magic * magic;
            var sqrtmagic = Math.sqrt(magic);
            dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
            dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);
            var mglat = lat + dlat;
            var mglng = lng + dlng;
            return [mglat, mglng];
        }

        function transformlat(lng, lat) {
            var PI = 3.1415926535897932384626;
            var ret = -100.0 + 2.0 * lng + 3.0 * lat + 0.2 * lat * lat + 0.1 * lng * lat + 0.2 * Math.sqrt(Math.abs(lng));
            ret += (20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(lat * PI) + 40.0 * Math.sin(lat / 3.0 * PI)) * 2.0 / 3.0;
            ret += (160.0 * Math.sin(lat / 12.0 * PI) + 320 * Math.sin(lat * PI / 30.0)) * 2.0 / 3.0;
            return ret;
        }

        function transformlng(lng, lat) {
            var PI = 3.1415926535897932384626;
            var ret = 300.0 + lng + 2.0 * lat + 0.1 * lng * lng + 0.1 * lng * lat + 0.1 * Math.sqrt(Math.abs(lng));
            ret += (20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(lng * PI) + 40.0 * Math.sin(lng / 3.0 * PI)) * 2.0 / 3.0;
            ret += (150.0 * Math.sin(lng / 12.0 * PI) + 300.0 * Math.sin(lng / 30.0 * PI)) * 2.0 / 3.0;
            return ret;
        }

        function out_of_china(lng, lat) {
            return (lng < 72.004 || lng > 137.8347) || ((lat < 0.8293 || lat > 55.8271) || false);
        }

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            // ä¸‰å±±å²›ä¸­å¿ƒåæ ‡ (WGS84)
            const centerWGS = [31.03, 120.29];
            // è½¬æ¢ä¸º GCJ02
            const centerGCJ = wgs84togcj02(centerWGS[1], centerWGS[0]);
            
            map = L.map('map-container').setView(centerGCJ, 14);

            // ä½¿ç”¨é«˜å¾·åœ°å›¾ç“¦ç‰‡ (GCJ02åæ ‡ç³») - å«æ˜Ÿå›¾
            L.tileLayer('https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}', {
                attribution: '&copy; é«˜å¾·åœ°å›¾',
                maxZoom: 18,
                minZoom: 10
            }).addTo(map);

            // æ·»åŠ è·¯ç½‘æ ‡æ³¨å›¾å±‚
            L.tileLayer('https://webst02.is.autonavi.com/appmaptile?style=8&x={x}&y={y}&z={z}', {
                maxZoom: 18,
                minZoom: 10,
                opacity: 0.8
            }).addTo(map);

            // è·å–å¹¶æ·»åŠ è§‚æµ‹ç‚¹
            fetch('/api/points')
                .then(response => response.json())
                .then(points => {
                    points.forEach(point => {
                        // è½¬æ¢åæ ‡ WGS84 -> GCJ02
                        const gcjPt = wgs84togcj02(point.longitude, point.latitude);
                        const marker = L.marker(gcjPt).addTo(map);
                        
                        // éš¾åº¦é¢œè‰²
                        let difficultyColor = '#10b981'; // ç®€å• - ç»¿è‰²
                        if (point.difficulty === 'å›°éš¾') difficultyColor = '#ef4444'; // å›°éš¾ - çº¢è‰²
                        else if (point.difficulty === 'ä¸­ç­‰') difficultyColor = '#f59e0b'; // ä¸­ç­‰ - é»„è‰²

                        const popupContent = `
                            <div style="color: #333; min-width: 200px;">
                                <h3 style="margin: 0 0 8px 0; color: #3b82f6;">${point.name}</h3>
                                <p style="margin: 4px 0;"><strong>ç»åº¦:</strong> ${point.longitude}</p>
                                <p style="margin: 4px 0;"><strong>çº¬åº¦:</strong> ${point.latitude}</p>
                                <p style="margin: 4px 0;"><strong>äº¤é€šéš¾æ˜“ç¨‹åº¦:</strong> <span style="color: ${difficultyColor}; font-weight: bold;">${point.difficulty}</span></p>
                                <p style="margin: 4px 0;"><strong>å…‰æ±¡æŸ“æŒ‡æ•°:</strong> Bortle ${point.bortle} (SQM ${point.sqm})</p>
                                <p style="margin: 4px 0;"><strong>è§†è§’:</strong> ${point.view_start}Â° - ${point.view_end}Â°</p>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                    });
                })
                .catch(error => console.error('Error loading points:', error));

            // ç»‘å®šå¯»æ‰¾é‡å¤–ç‚¹æŒ‰é’®äº‹ä»¶
            // const findWildBtn = document.getElementById('findWildBtn');
            // if (findWildBtn) {
            //     findWildBtn.addEventListener('click', loadWildSpots);
            // }
        }

        // åŠ è½½å¤©æ°”æ•°æ®
        async function loadWeather() {
            const container = document.getElementById('weather-container');
            try {
                const response = await fetch('/api/weather');
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error);
                
                // è§‚æ˜Ÿæ¡ä»¶é¢œè‰²
                let conditionColor = '#ef4444'; // å·®
                if (data.stargazing_score >= 80) conditionColor = '#10b981'; // æä½³
                else if (data.stargazing_score >= 60) conditionColor = '#3b82f6'; // è‰¯å¥½
                else if (data.stargazing_score >= 40) conditionColor = '#f59e0b'; // ä¸€èˆ¬
                
                container.innerHTML = `
                    <div class="weather-card" style="border-color: ${conditionColor}; background: rgba(${parseInt(conditionColor.slice(1,3),16)}, ${parseInt(conditionColor.slice(3,5),16)}, ${parseInt(conditionColor.slice(5,7),16)}, 0.1);">
                        <i class="fas fa-star" style="color: ${conditionColor};"></i>
                        <div class="label">è§‚æ˜ŸæŒ‡æ•°</div>
                        <div class="data" style="color: ${conditionColor};">${data.stargazing_score}</div>
                        <div class="condition-badge" style="background: ${conditionColor}; color: #fff;">${data.condition_text}</div>
                    </div>
                    
                    <div class="weather-card">
                        <i class="fas fa-temperature-high"></i>
                        <div class="label">æ°”æ¸©</div>
                        <div class="data">${data.temperature}Â°C</div>
                    </div>
                    
                    <div class="weather-card">
                        <i class="fas fa-cloud"></i>
                        <div class="label">äº‘é‡</div>
                        <div class="data">${data.cloud_cover}%</div>
                    </div>
                    
                    <div class="weather-card">
                        <i class="fas fa-moon"></i>
                        <div class="label">æœˆç›¸</div>
                        <div class="data">${data.moon_phase_text}</div>
                        <div class="label" style="font-size: 0.75em;">${(data.moon_phase * 100).toFixed(0)}% è¢«ç…§äº®</div>
                    </div>
                    
                    <div class="weather-card">
                        <i class="fas fa-wind"></i>
                        <div class="label">é£é€Ÿ</div>
                        <div class="data">${data.wind_speed} km/h</div>
                    </div>
                `;

                // æ¸²æŸ“å¤©æ°”è¶‹åŠ¿å›¾è¡¨
                if (data.forecast && data.forecast.length > 0) {
                    const chartDom = document.getElementById('weather-chart');
                    chartDom.style.display = 'block';
                    const myChart = echarts.init(chartDom);
                    
                    const times = data.forecast.map(item => item.time);
                    const temps = data.forecast.map(item => item.temperature);
                    const clouds = data.forecast.map(item => item.cloud_cover);
                    const humidities = data.forecast.map(item => item.humidity);

                    const option = {
                        backgroundColor: 'transparent',
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'cross' },
                            backgroundColor: 'rgba(50, 50, 50, 0.9)',
                            borderColor: '#555',
                            textStyle: { color: '#fff' }
                        },
                        legend: {
                            data: ['æ°”æ¸© (Â°C)', 'äº‘é‡ (%)', 'æ¹¿åº¦ (%)'],
                            textStyle: { color: '#ccc' }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: times,
                            axisLine: { lineStyle: { color: '#555' } },
                            axisLabel: { color: '#aaa' }
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: 'æ°”æ¸©',
                                position: 'left',
                                axisLine: { show: true, lineStyle: { color: '#ffa116' } },
                                axisLabel: { formatter: '{value} Â°C', color: '#ffa116' },
                                splitLine: { lineStyle: { color: '#333' } }
                            },
                            {
                                type: 'value',
                                name: 'ç™¾åˆ†æ¯”',
                                min: 0,
                                max: 100,
                                position: 'right',
                                axisLine: { show: true, lineStyle: { color: '#aaa' } },
                                axisLabel: { formatter: '{value} %', color: '#aaa' },
                                splitLine: { show: false }
                            }
                        ],
                        series: [
                            {
                                name: 'æ°”æ¸© (Â°C)',
                                type: 'line',
                                yAxisIndex: 0,
                                data: temps,
                                smooth: true,
                                itemStyle: { color: '#ffa116' },
                                lineStyle: { width: 3 }
                            },
                            {
                                name: 'äº‘é‡ (%)',
                                type: 'line',
                                yAxisIndex: 1,
                                data: clouds,
                                smooth: true,
                                areaStyle: { opacity: 0.2 },
                                itemStyle: { color: '#0a84ff' },
                                lineStyle: { width: 2 }
                            },
                            {
                                name: 'æ¹¿åº¦ (%)',
                                type: 'line',
                                yAxisIndex: 1,
                                data: humidities,
                                smooth: true,
                                itemStyle: { color: '#2cbb5d' },
                                lineStyle: { width: 2, type: 'dashed' }
                            }
                        ]
                    };

                    myChart.setOption(option);
                    
                    // å“åº”çª—å£å¤§å°å˜åŒ–
                    window.addEventListener('resize', function() {
                        myChart.resize();
                    });
                }
                
            } catch (error) {
                console.error('Weather error:', error);
                container.innerHTML = `
                    <div class="error" style="grid-column: 1/-1; padding: 15px;">
                        <i class="fas fa-exclamation-triangle"></i> å¤©æ°”æ•°æ®åŠ è½½å¤±è´¥
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            loadWeather();

            // åŠ è½½ä¿å­˜çš„AHPè®¾ç½®
            const savedLoc = localStorage.getItem('ahp_score_loc');
            const savedView = localStorage.getItem('ahp_score_view');
            const savedDiff = localStorage.getItem('ahp_score_diff');
            const savedLp = localStorage.getItem('ahp_score_lp');
            
            if (savedLoc) {
                document.getElementById('score_loc').value = savedLoc;
                document.getElementById('score_loc_val').textContent = savedLoc;
            }
            if (savedView) {
                document.getElementById('score_view').value = savedView;
                document.getElementById('score_view_val').textContent = savedView;
            }
            if (savedDiff) {
                document.getElementById('score_diff').value = savedDiff;
                document.getElementById('score_diff_val').textContent = savedDiff;
            }
            if (savedLp) {
                document.getElementById('score_lp').value = savedLp;
                document.getElementById('score_lp_val').textContent = savedLp;
            }
            
            // ç»‘å®šä¿å­˜äº‹ä»¶
            document.getElementById('score_loc').addEventListener('input', function() {
                localStorage.setItem('ahp_score_loc', this.value);
            });
            document.getElementById('score_view').addEventListener('input', function() {
                localStorage.setItem('ahp_score_view', this.value);
            });
            document.getElementById('score_diff').addEventListener('input', function() {
                localStorage.setItem('ahp_score_diff', this.value);
            });
            document.getElementById('score_lp').addEventListener('input', function() {
                localStorage.setItem('ahp_score_lp', this.value);
            });
        });
    </script>
    <script src="{{ url_for('static', filename='js/star-bg.js') }}"></script>
    <script src="{{ url_for('static', filename='js/red-mode.js') }}"></script>
</body>
</html>
